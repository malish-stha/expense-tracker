{"version":3,"file":"buildContext.js","names":["_passport","_interopRequireDefault","require","obj","__esModule","default","promisifiedAuthentication","req","res","name","options","Promise","resolve","reject","done","err","user","info","authFn","passport","authenticate","promisifiedLogin","login","promisifiedLogout","logout","buildCommonContext","additionalContext","isAuthenticated","isUnauthenticated","getUser","strategyName","Error","buildContext","contextParams","connection","payload","context","sharedContext","_default","exports"],"sources":["../src/buildContext.ts"],"sourcesContent":["/* eslint-disable max-len */\nimport passport, { AuthenticateOptions } from 'passport';\nimport express from 'express';\nimport { ExecutionParams } from 'subscriptions-transport-ws';\nimport { AuthenticateReturn, InfoArgument } from './types';\n\nconst promisifiedAuthentication = <UserObjectType extends Express.User>(\n  req: express.Request,\n  res: express.Response,\n  name: string,\n  options: AuthenticateOptions,\n) =>\n  new Promise<AuthenticateReturn<UserObjectType>>((resolve, reject) => {\n    const done = (err: Error | undefined, user: UserObjectType | undefined, info?: InfoArgument | undefined) => {\n      if (err) reject(err);\n      else resolve({ user, info });\n    };\n\n    const authFn = passport.authenticate(name, options, done);\n    return authFn(req, res);\n  });\n\nconst promisifiedLogin = <UserObjectType extends Express.User>(\n  req: express.Request,\n  user: UserObjectType,\n  options?: AuthenticateOptions,\n) =>\n  new Promise<void>((resolve, reject) => {\n    const done = (err: Error | undefined) => {\n      if (err) reject(err);\n      else resolve();\n    };\n\n    req.login(user, options, done);\n  });\n\nconst promisifiedLogout = (req: express.Request, options?: { keepSessionInfo?: boolean }) =>\n  new Promise<void>((resolve, reject) => {\n    const done = (err: Error | undefined) => {\n      if (err) reject(err);\n      else resolve();\n    };\n\n    req.logout(options, done);\n  });\n\nexport interface CommonRequest<UserObjectType extends Express.User>\n  extends Pick<Context<UserObjectType>, 'isAuthenticated' | 'isUnauthenticated'> {\n  user?: UserObjectType;\n}\n\nexport interface Context<UserObjectType extends Express.User> {\n  isAuthenticated: () => boolean;\n  isUnauthenticated: () => boolean;\n  getUser: () => UserObjectType;\n  authenticate: (strategyName: string, options?: object) => Promise<AuthenticateReturn<UserObjectType>>;\n  login: (user: UserObjectType, options?: object) => Promise<void>;\n  logout: (options?: object) => Promise<void>;\n  res?: express.Response;\n  req: CommonRequest<UserObjectType>;\n}\n\nconst buildCommonContext = <UserObjectType extends Express.User>(\n  req: CommonRequest<UserObjectType>,\n  additionalContext: {},\n) => ({\n  isAuthenticated: () => req.isAuthenticated(),\n  isUnauthenticated: () => req.isUnauthenticated(),\n  getUser: () => req.user,\n  authenticate: (strategyName: string) => {\n    throw new Error(`Authenticate (${strategyName}) not implemented for subscriptions`);\n  },\n  login: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  logout: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  req,\n  ...additionalContext,\n});\n\nexport interface ContextParams {\n  req: express.Request;\n  res: express.Response;\n  connection?: ExecutionParams;\n  payload?: unknown;\n}\n\n// function buildContext(contextParams: RegularContextParams): Context;\n// function buildContext(contextParams: SubscriptionContextParams): SubscriptionContext;\nconst buildContext = <UserObjectType extends Express.User, R extends ContextParams = ContextParams>(\n  contextParams: R,\n): Context<UserObjectType> => {\n  const {\n    req, // set for queries and mutations\n    res, // set for queries and mutations\n    connection, // set for subscriptions\n    payload, // set for subscriptions\n    ...additionalContext\n  } = contextParams;\n\n  if (connection) {\n    return buildCommonContext<UserObjectType>(connection.context.req, additionalContext);\n  }\n\n  // The UserObject is without the any in conflict: \"'User' is not assignable to type 'UserObjectType'\"\n  const sharedContext = buildCommonContext<UserObjectType>(req as any, additionalContext);\n  return {\n    ...sharedContext,\n    authenticate: (name: string, options: AuthenticateOptions) => promisifiedAuthentication(req, res, name, options),\n    login: (user: UserObjectType, options: AuthenticateOptions) => promisifiedLogin<UserObjectType>(req, user, options),\n    logout: (options: { keepSessionInfo?: boolean }) => promisifiedLogout(req, options),\n    res,\n  };\n};\n\nexport default buildContext;\n"],"mappings":"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"}